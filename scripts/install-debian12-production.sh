#!/bin/bash

# Script d'installation production MediResolv pour Debian 12
# S√©curit√© niveau entreprise avec MariaDB

set -euo pipefail

# Configuration
readonly SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
readonly APP_NAME="mediresolv"
readonly APP_DIR="/opt/${APP_NAME}"
readonly SERVICE_USER="mediresolv"
readonly LOG_FILE="/var/log/${APP_NAME}_install.log"

# Couleurs
readonly RED='\033[0;31m'
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# Fonctions de logging
log() {
    echo -e "${GREEN}[INFO]${NC} $*" | tee -a "$LOG_FILE"
}

warn() {
    echo -e "${YELLOW}[WARN]${NC} $*" | tee -a "$LOG_FILE"
}

error() {
    echo -e "${RED}[ERROR]${NC} $*" | tee -a "$LOG_FILE"
    exit 1
}

info() {
    echo -e "${BLUE}[INFO]${NC} $*" | tee -a "$LOG_FILE"
}

check_root() {
    if [[ $EUID -ne 0 ]]; then
        error "Ce script doit √™tre ex√©cut√© en tant que root (sudo)"
    fi
}

check_debian_version() {
    if ! grep -q "bookworm" /etc/os-release; then
        error "Ce script est con√ßu pour Debian 12 (Bookworm)"
    fi
    log "‚úÖ Debian 12 d√©tect√©"
}

choose_ssl() {
    echo "Souhaitez-vous activer SSL/TLS avec Certificat ? (Y/n) : "
    read -r use_ssl
    if [[ $use_ssl =~ ^([yY][eE][sS]|[yY])$ ]]; then
        USE_SSL=true
    else
        USE_SSL=false
    fi
    log "Option SSL : $USE_SSL"
}

update_system() {
    info "üì¶ Mise √† jour du syst√®me Debian..."
    apt update && apt upgrade -y
    apt install -y curl wget gnupg2 software-properties-common apt-transport-https ca-certificates
    log "‚úÖ Syst√®me mis √† jour"
}

install_nodejs() {
    info "üì¶ Installation de Node.js 18..."
    curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
    apt install -y nodejs
    NODE_VERSION=$(node --version)
    NPM_VERSION=$(npm --version)
    if [[ "${NODE_VERSION:1:2}" -lt "18" ]]; then
        error "Node.js 18+ requis. Version install√©e: $NODE_VERSION"
    fi
    log "‚úÖ Node.js $NODE_VERSION install√©"
    log "‚úÖ npm $NPM_VERSION install√©"
}

install_mariadb() {
    info "üì¶ Installation de MariaDB 10.11..."
    apt install -y mariadb-server mariadb-client
    systemctl start mariadb
    systemctl enable mariadb
    MARIADB_VERSION=$(mysql --version | awk '{print $5}' | awk -F, '{print $1}')
    log "‚úÖ MariaDB $MARIADB_VERSION install√©"
    setup_mariadb_security
}

setup_mariadb_security() {
    info "üîê Configuration s√©curis√©e de MariaDB..."
    MYSQL_ROOT_PASSWORD=$(openssl rand -base64 32)
    DB_PASSWORD=$(openssl rand -base64 32)
    mysql -u root << EOF
ALTER USER 'root'@'localhost' IDENTIFIED BY '${MYSQL_ROOT_PASSWORD}';
FLUSH PRIVILEGES;

CREATE DATABASE IF NOT EXISTS mediresolv CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
CREATE USER IF NOT EXISTS 'mediresolv'@'localhost' IDENTIFIED BY '${DB_PASSWORD}';
GRANT ALL PRIVILEGES ON mediresolv.* TO 'mediresolv'@'localhost';
GRANT CREATE, DROP, INDEX, ALTER ON mediresolv.* TO 'mediresolv'@'localhost';
FLUSH PRIVILEGES;
EOF

    cat > /root/.mariadb_passwords << EOF
# MediResolv - Mots de passe MariaDB
# GARDEZ CE FICHIER EN S√âCURIT√â !

MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
DB_PASSWORD=${DB_PASSWORD}
DB_USER=mediresolv
DB_NAME=mediresolv

# Date de cr√©ation: $(date)
EOF

    chmod 600 /root/.mariadb_passwords
    log "‚úÖ MariaDB s√©curis√© - Mots de passe sauvegard√©s dans /root/.mariadb_passwords"
}

install_nginx() {
    info "üåê Installation et configuration de Nginx..."
    apt install -y nginx certbot python3-certbot-nginx
    configure_nginx
    systemctl start nginx
    systemctl enable nginx
    log "‚úÖ Nginx install√© et configur√©"
}

configure_nginx() {
    NGINX_CONF_DIR="/etc/nginx/sites-enabled"
    NGINX_CONF="$NGINX_CONF_DIR/mediresolv.conf"

    if [ ! -d "$NGINX_CONF_DIR" ]; then
        echo "Cr√©ation du dossier $NGINX_CONF_DIR"
        mkdir -p "$NGINX_CONF_DIR"
    fi

    if [ "$USE_SSL" = true ]; then
        cp "${SCRIPT_DIR}/../docker/nginx/with-ssl.conf" "$NGINX_CONF"
    else
        cp "${SCRIPT_DIR}/../docker/nginx/no-ssl.conf" "$NGINX_CONF"
    fi

    systemctl restart nginx
}

create_system_user() {
    info "üë§ Cr√©ation de l'utilisateur syst√®me..."
    if ! id "$SERVICE_USER" &>/dev/null; then
        useradd --system --home "$APP_DIR" --shell /bin/bash --create-home "$SERVICE_USER"
        log "‚úÖ Utilisateur $SERVICE_USER cr√©√©"
    else
        log "‚úÖ Utilisateur $SERVICE_USER existe d√©j√†"
    fi
}

install_application() {
    info "üì¶ Installation de l'application MediResolv..."
    mkdir -p "$APP_DIR"/{backend,frontend,logs,backups,uploads}
    if [[ -d "./backend" ]]; then
        cp -r ./backend/* "$APP_DIR/backend/"
        cp -r ./frontend/* "$APP_DIR/frontend/"
    else
        error "Fichiers source introuvables. Assurez-vous d'√™tre dans le r√©pertoire du projet."
    fi
    cd "$APP_DIR/backend"
    npm ci --only=production
    chown -R "$SERVICE_USER:$SERVICE_USER" "$APP_DIR"
    chmod -R 755 "$APP_DIR"
    chmod -R 700 "$APP_DIR/logs"
    chmod -R 755 "$APP_DIR/uploads"
    log "‚úÖ Application install√©e"
}

setup_environment() {
    info "‚öôÔ∏è Configuration de l'environnement..."
    DB_PASSWORD=$(grep "DB_PASSWORD=" /root/.mariadb_passwords | cut -d'=' -f2)
    JWT_SECRET=$(openssl rand -base64 64)
    cat > "$APP_DIR/backend/.env" << EOF
# Configuration production MediResolv
NODE_ENV=production
PORT=3000

# Base de donn√©es MariaDB
DB_HOST=localhost
DB_USER=mediresolv
DB_PASSWORD=${DB_PASSWORD}
DB_NAME=mediresolv
DB_PORT=3306

# S√©curit√© JWT
JWT_SECRET=${JWT_SECRET}
JWT_EXPIRE=8h

# Application
FRONTEND_URL=https://$(hostname -f)
UPLOAD_DIR=${APP_DIR}/backend/uploads
MAX_FILE_SIZE=10485760

# Logs
LOG_LEVEL=info
LOG_DIR=${APP_DIR}/logs

# Email (√† configurer)
EMAIL_HOST=smtp.gmail.com
EMAIL_PORT=587
EMAIL_USER=
EMAIL_PASS=

# Redis (optionnel)
REDIS_HOST=127.0.0.1
REDIS_PORT=6379

# Sauvegardes
BACKUP_DIR=${APP_DIR}/backups
BACKUP_RETENTION_DAYS=30
EOF
    chown "$SERVICE_USER:$SERVICE_USER" "$APP_DIR/backend/.env"
    chmod 600 "$APP_DIR/backend/.env"
    log "‚úÖ Configuration environnement cr√©√©e"
}

setup_systemd_service() {
    info "üîÑ Configuration du service systemd..."
    cat > /etc/systemd/system/${APP_NAME}.service << EOF
[Unit]
Description=MediResolv - Syst√®me de Gestion d'Interventions
Documentation=https://github.com/lesdavils/MediResolv
After=network.target mariadb.service
Wants=mariadb.service

[Service]
Type=simple
User=${SERVICE_USER}
Group=${SERVICE_USER}
WorkingDirectory=${APP_DIR}/backend
ExecStart=/usr/bin/node server.js
ExecReload=/bin/kill -HUP \$MAINPID
Restart=always
RestartSec=10
TimeoutStopSec=30

# Variables d'environnement
Environment=NODE_ENV=production
EnvironmentFile=${APP_DIR}/backend/.env

# S√©curit√© systemd
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=${APP_DIR}
ProtectKernelTunables=true
ProtectKernelModules=true
ProtectControlGroups=true

# Limites de ressources
LimitNOFILE=65536
LimitNPROC=4096

# Logging
StandardOutput=journal
StandardError=journal
SyslogIdentifier=${APP_NAME}

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable ${APP_NAME}
    log "‚úÖ Service systemd configur√©"
}

initialize_database() {
    info "üóÑÔ∏è Initialisation de la base de donn√©es..."
    DB_PASSWORD=$(grep "DB_PASSWORD=" /root/.mariadb_passwords | cut -d'=' -f2)
    if [[ -f "./database/mariadb-schema.sql" ]]; then
        mysql -u mediresolv -p"${DB_PASSWORD}" mediresolv < ./database/mariadb-schema.sql
        log "‚úÖ Sch√©ma de base import√©"
    fi
    ADMIN_EXISTS=$(mysql -u mediresolv -p"${DB_PASSWORD}" mediresolv -N -e "SELECT COUNT(*) FROM users WHERE role = 'admin';")
    if [[ "$ADMIN_EXISTS" -eq "0" ]]; then
        warn "Aucun administrateur trouv√© - cr√©ation du compte admin"
        ADMIN_HASH='$2b$12$LQv3vZ2'
        mysql -u mediresolv -p"${DB_PASSWORD}" mediresolv << EOF
INSERT INTO users (username, email, password_hash, nom, prenom, role, statut, doit_changer_mot_passe) 
VALUES ('admin', 'admin@mediresolv.fr', '${ADMIN_HASH}', 'Administrateur', 'Syst√®me', 'admin', 'actif', TRUE);
EOF
        log "‚úÖ Compte administrateur cr√©√© (admin / Admin123!@#)"
        warn "‚ö†Ô∏è  CHANGEZ LE MOT DE PASSE ADMINISTRATEUR IMM√âDIATEMENT"
    fi
}

setup_firewall() {
    info "üî• Configuration du firewall..."
    if command -v ufw >/dev/null 2>&1; then
        ufw --force enable
        ufw default deny incoming
        ufw default allow outgoing
        ufw allow 22/tcp comment 'SSH'
        ufw allow 80/tcp comment 'HTTP'
        ufw allow 443/tcp comment 'HTTPS'
        ufw deny 3306/tcp comment 'MariaDB blocked externally'
        log "‚úÖ Firewall configur√©"
    else
        warn "‚ö†Ô∏è  UFW non disponible - configurez le firewall manuellement"
    fi
}

setup_log_rotation() {
    info "üìù Configuration de la rotation des logs..."
    cat > /etc/logrotate.d/${APP_NAME} << EOF
${APP_DIR}/logs/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 ${SERVICE_USER} ${SERVICE_USER}
    postrotate
        systemctl reload ${APP_NAME} > /dev/null 2>&1 || true
    endscript
}
EOF
    log "‚úÖ Rotation des logs configur√©e"
}

setup_backup() {
    info "üíæ Configuration des sauvegardes automatiques..."
    cat > /usr/local/bin/${APP_NAME}-backup << 'EOF'
#!/bin/bash
# Sauvegarde automatique MediResolv

BACKUP_DIR="/opt/mediresolv/backups"
DB_NAME="mediresolv"
DB_USER="mediresolv"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/backup_${TIMESTAMP}.sql.gz"

DB_PASSWORD=$(grep "DB_PASSWORD=" /root/.mariadb_passwords | cut -d'=' -f2)

mariadb-dump -u "$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" | gzip > "$BACKUP_FILE"

if [[ $? -eq 0 ]]; then
    echo "‚úÖ Sauvegarde cr√©√©e: $BACKUP_FILE"

    find "$BACKUP_DIR" -name "backup_*.sql.gz" -mtime +30 -delete
else
    echo "‚ùå Erreur lors de la sauvegarde"
    exit 1
fi
EOF

    chmod +x /usr/local/bin/${APP_NAME}-backup
    echo "0 2 * * * /usr/local/bin/${APP_NAME}-backup" | crontab -
    log "‚úÖ Sauvegardes automatiques configur√©es (2h du matin)"
}

run_tests() {
    info "üß™ Tests de fonctionnement..."
    if systemctl is-active --quiet mariadb; then
        log "‚úÖ MariaDB op√©rationnel"
    else
        error "‚ùå MariaDB non op√©rationnel"
    fi
    if systemctl is-active --quiet nginx; then
        log "‚úÖ Nginx op√©rationnel"
    else
        error "‚ùå Nginx non op√©rationnel"
    fi
    systemctl start ${APP_NAME}
    sleep 10
    if systemctl is-active --quiet ${APP_NAME}; then
        log "‚úÖ Application MediResolv op√©rationnelle"
        if curl -sf http://localhost:3000/health > /dev/null; then
            log "‚úÖ Health check r√©ussi"
        else
            warn "‚ö†Ô∏è  Health check √©chou√©"
        fi
    else
        error "‚ùå Application non op√©rationnelle"
    fi
}

display_summary() {
    log "üéâ Installation de MediResolv termin√©e avec succ√®s !"
    echo
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo -e "${GREEN}üè• MediResolv INSTALL√â AVEC SUCC√àS üè•${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
    echo
    echo -e "${BLUE}üìç ACC√àS APPLICATION :${NC}"
    echo "   URL: https://$(hostname -f)"
    echo "   Sant√©: https://$(hostname -f)/health"
    echo
    echo -e "${BLUE}üîë COMPTE ADMINISTRATEUR :${NC}"
    echo "   Utilisateur: admin"
    echo "   Mot de passe: Admin123!@#"
    echo -e "   ${RED}‚ö†Ô∏è  CHANGEZ CE MOT DE PASSE IMM√âDIATEMENT !${NC}"
    echo
    echo -e "${BLUE}üóÑÔ∏è  BASE DE DONN√âES :${NC}"
    echo "   Type: MariaDB $(mysql --version | awk '{print $5}' | awk -F, '{print $1}')"
    echo "   Base: mediresolv"
    echo "   Mots de passe: /root/.mariadb_passwords"
    echo
    echo -e "${BLUE}üîß GESTION DU SERVICE :${NC}"
    echo "   Statut: systemctl status ${APP_NAME}"
    echo "   Red√©marrer: systemctl restart ${APP_NAME}"
    echo "   Logs: journalctl -u ${APP_NAME} -f"
    echo
    echo -e "${BLUE}üíæ SAUVEGARDES :${NC}"
    echo "   Auto: Quotidiennes √† 2h du matin"
    echo "   Manuel: /usr/local/bin/${APP_NAME}-backup"
    echo "   Dossier: ${APP_DIR}/backups"
    echo
    echo -e "${BLUE}üìÅ FICHIERS IMPORTANTS :${NC}"
    echo "   Application: ${APP_DIR}"
    echo "   Configuration: ${APP_DIR}/backend/.env"
    echo "   Logs: ${APP_DIR}/logs"
    echo "   Service: /etc/systemd/system/${APP_NAME}.service"
    echo
    echo -e "${YELLOW}üìã PROCHAINES √âTAPES :${NC}"
    echo "   1. Configurez SSL/HTTPS avec certbot"
    echo "   2. Changez le mot de passe administrateur"
    echo "   3. Configurez l'email SMTP"
    echo "   4. Cr√©ez vos utilisateurs"
    echo "   5. Importez vos donn√©es clients"
    echo
    echo -e "${GREEN}üéØ MediResolv est pr√™t pour la production ! ${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
}

main() {
    echo -e "${BLUE}üöÄ Installation MediResolv pour Debian 12${NC}"
    echo -e "${BLUE}   Production Ready - S√©curit√© Entreprise${NC}"
    echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"

    check_root
    check_debian_version
    update_system
    install_nodejs
    install_mariadb

    choose_ssl

    install_nginx
    create_system_user
    install_application
    setup_environment
    setup_systemd_service
    initialize_database
    setup_firewall
    setup_log_rotation
    setup_backup
    run_tests
    display_summary

    log "‚úÖ Installation termin√©e avec succ√®s"
}

trap 'error "Installation interrompue √† la ligne $LINENO"' ERR
trap 'log "Installation interrompue par l'\''utilisateur"' INT TERM

main "$@"
